---
title: "Установка почтового сервера iRedMail на CentOS 7. Часть 7. Белый список Graylisting, WEB-интерфейс, квота Dovecot"
date: "2019-02-12"
categories: 
  - Linux
  - iRedMail
tags: 
  - "centos"
  - "dovecot"
  - "iredmail"
  - "whitelist"
  - "nginx"
image:
  path: /commons/1032198_11a3_4.jpg
  alt: "Установка iRedMail"
---

> **Greylisting** — способ автоматической блокировки спама, основанный на том, что «поведение» программного обеспечения, предназначенного для рассылки спама, отличается от поведения обычных серверов электронной почты. Если почтовый сервер получателя отказывается принять письмо и сообщает о «временной ошибке», сервер отправителя обязан позже повторить попытку. Спамерское программное обеспечение в таких случаях, обычно, не пытается этого делать.
> Белый список - список доменный имен, которым вы доверяете, и которых не надо проверять на спам через amavisd / spamassassin
{: .prompt-tip }

## Белый список Greylisting

Документация по управлению белым списком можно посмотреть на официальном сайте iRedMail

Например, для просмотра белого списка можно использовать python-скрипт, который находится в каталоге `/opt/iredapd/tools/`

```sh
$ cd /opt/iredapd/tools/
$ sudo python greylisting_admin.py --list-whitelist-domains
```

Для добавления доверенного доменного имени в белый список надо выполнить SQL-запрос

```sh
> INSERT INTO `iredapd`.`greylisting_whitelist_domains` (`id`, `domain`) VALUES (NULL, 'itdraft.ru');
```

## Web-интерфейс для управления белым списком Greylisting

Мне не захотелось использовать phpMyAdmin для управления белым списком Greylisting, по-этому быстренько набросал свою админку.

Возможности админки:

- Добавлять в список
- Редактировать запись
- Удалять из списка

[Скачать (github)](https://github.com/bullvinkl/greylist)

Для установки вэб-интерфейса создаем директорию:

```sh
$ sudo mkdir /var/www/html/whitelist
```

Распаковываем в эту директорию файлы из архива, редактируем файлы:  
— в файле server.php — отредактировать строку 3 (заменить %password% на свое значение)

Ограничиваем доступ к вэб-интерфейсу управлением белым списком Graylisting по ip

```sh
$ sudo nano /etc/nginx/templates/misc.tmpl
...
location ~ ^/whitelist/$ {
    allow %ip%;
    deny all;
}
```

где
- `%ip% `— ip-адрес, которому разрешен доступ

Перезагружаем Nginx

```sh
$ sudo systemctl restart nginx
```

## Квота Dovecot

После переноса почтовых сообщений со старого сервера на новый, не верно отображалась квота почтового ящика в web-клиенте `SOGo`

Что бы это исправить, надо выполнить команду:

```sh
$ sudo doveadm quota recalc -A
```
